/**
 * main.mjs haesung.github.io/stock
 * (C)2024 Haesung Kim, All Rights Reserved
 * ------------------------------------------------------------------
 * v1.0.0
 * ------------------------------------------------------------------
 */
"use strict";import{getCases,getDate}from"./datac.mjs";let my;const makePages=function(){document.querySelector(`select option[value=${my.page}]`).outerHTML=`<option value="${my.page}" selected>${my.page}</option>`;const action={test:["zz"]};my.pages=Object.keys(action);let pagesHtml=my.pages.reduce(((acc1,page)=>(acc1+=`<form id="${page}">`,`${acc1+=action[page].reduce(((acc2,name)=>{switch(acc2+=`${my.text[name]}<br>`,my.type[name]){case"radio":acc2+=my.values[name].reduce(((acc3,value)=>{const text=void 0===my.map[name]?value:my.map[name][value];return acc3+=`\n              <label>\n                <input type="radio" name="${name}" value="${value}"\n            `,value===my.default[name]&&(acc3+=" checked"),acc3+`>${text}</label><br>`}),"");break;case"number":acc2+=`\n            <input\n              type="number"\n              name="${name}"\n              value="${my.default[name]}"\n              min="${my.values[name][0]}"\n              max="${my.values[name][1]}"\n              step="${my.values[name][2]}"\n            required><br>\n          `;break;default:acc2+=`\n            <input\n              type="${my.type[name]}"\n              name="${name}"\n              value="${my.default[name]}"\n            required><br>\n          `}return`${acc2}<br>`}),"")}</form>`)),"");pagesHtml+='<button id="go" class="button-go">GO</button>';document.querySelector("#pages").innerHTML+=pagesHtml},showMyPage=function(){my.pages.forEach((key=>{my.page===key?document.querySelector(`#${key}`).style.display="":document.querySelector(`#${key}`).style.display="none"}))},onSubmit=async function(){try{let query={};const myForm=document.forms.namedItem(my.page),itemCount=myForm.length;for(let i=0;i<itemCount;i+=1){const item=myForm.elements[i];if("radio"===item.type)item.checked&&"n/a"!==item.value&&("["===item.value[0]?query[item.name]=JSON.parse(item.value):query[item.name]=item.value);else{if(!item.validity.valid){const inform=`"${my.text[item.name]}" 항목을 입력하세요.`;return void(document.querySelector("#right").innerHTML=`${inform}`)}query[item.name]=item.value}}void 0!==query.zz&&(query=my.query[query.zz]);const date=await getDate();let bests;if(date===localStorage.getItem(`${my.cbName}.date`))bests=JSON.parse(localStorage.getItem(`${my.cbName}.bests`));else{const cases=await getCases(),cbrFindStock="https://4e2zqhgshroejadd7kvxyfbfpi0jtjot.lambda-url.ap-northeast-2.on.aws/",res=await fetch(cbrFindStock,{method:"post",body:JSON.stringify({query:query,cases:cases})});bests=(await res.json()).map((item=>(delete item.case.closePrices,delete item.case.volumes,item))),localStorage.setItem(`${my.cbName}.bests`,JSON.stringify(bests)),localStorage.setItem(`${my.cbName}.date`,date)}let text=`\n      <table>\n        <thead>\n          <tr>\n            <th></th>\n            <th>${bests[0].case.sk}</th>\n            <th>${bests[1].case.sk}</th>\n            <th>${bests[2].case.sk}</th>\n          </tr>\n          <tr>\n            <th>유사도 (%)</th>\n            <th>${(100*bests[0].similarity).toFixed(2)}</th>\n            <th>${(100*bests[1].similarity).toFixed(2)}</th>\n            <th>${(100*bests[2].similarity).toFixed(2)}</th>\n          </tr>\n        </thead>\n        <tbody>\n    `;text+=my.order.reduce(((acc1,name)=>{const values=bests.map((myCase=>{let value=myCase.case[name];return void 0===value?"-":"http"===value.slice(0,4)?`<a href="${value}" target="_blank">click</a>`:("object"==typeof value&&(value=JSON.stringify(value)),void 0!==my.map[name]&&(value=my.map[name][value]),value)}));return acc1+=`\n        <tr>\n          <td>${my.text[name]}</td>\n          <td>${values[0]}</td>\n          <td>${values[1]}</td>\n          <td>${values[2]}</td>\n        </tr>\n      `}),""),text=`${text}</tbody></table>`,text=`${text}<br>${date}`,document.querySelector("#right").innerHTML=text}catch(e){console.error("onSubmit:",e.message)}},iife=async function(){try{const cbName=location.pathname.split("/")[1];if(null===localStorage.getItem(cbName)){const cbrGetUi="https://u4habswkjkux2kjewsxpyxzqbe0yhcva.lambda-url.ap-northeast-2.on.aws/",res=await fetch(cbrGetUi,{method:"post",body:cbName});my=await res.json();const defaultMap=my.default;delete my.default,localStorage.setItem(cbName,JSON.stringify(my)),localStorage.setItem(`${cbName}.default`,JSON.stringify(defaultMap)),my.default=defaultMap,my.page="test",localStorage.setItem(`${cbName}.page`,my.page)}else my=JSON.parse(localStorage.getItem(cbName)),my.default=JSON.parse(localStorage.getItem(`${cbName}.default`)),my.page=localStorage.getItem(`${cbName}.page`);my.cbName=cbName,makePages(),showMyPage(),document.querySelector("#pages").style.display="",document.querySelector("body").style.display="",document.querySelector("select").addEventListener("change",(e=>{my.page=e.target.value,localStorage.setItem(`${my.cbName}.page`,my.page),showMyPage()})),document.querySelector("#go").addEventListener("click",onSubmit),document.addEventListener("visibilitychange",(()=>{if("hidden"===document.visibilityState){const myForm=document.forms.namedItem(my.page),itemCount=myForm.length;for(let i=0;i<itemCount;i+=1){const item=myForm.elements[i];"radio"===item.type?item.checked&&(my.default[item.name]=item.value):my.default[item.name]=item.value}localStorage.setItem(`${my.cbName}.default`,JSON.stringify(my.default))}}))}catch(e){console.error("iife:",e.message)}}();
